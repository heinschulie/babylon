import{c as ve,a as r,t as P,f as l}from"../chunks/1f615a2c.js";import{p as Wa,d as _a,m as M,v as ma,i as e,l as a,f as x,a as Xa,o as Se,c as i,s as t,r as s,n as y,t as f}from"../chunks/8b0cb860.js";import{s as g}from"../chunks/63f41f2c.js";import{i as k,s as ga,a as Za}from"../chunks/c17651b9.js";import{e as $a,i as ha}from"../chunks/62e4c738.js";import{c as v}from"../chunks/c1381360.js";import{r as Re,s as Ae}from"../chunks/0701c483.js";import{g as ia}from"../chunks/dd297ec3.js";import{p as er}from"../chunks/4b7ed212.js";import{a as V}from"../chunks/fb331d7f.js";import{B as pe}from"../chunks/8f85ef07.js";import{C as Be}from"../chunks/840838e0.js";import{C as la}from"../chunks/3cc6752e.js";import{C as We,a as Xe,b as Ze}from"../chunks/4e6716dc.js";import{C as na}from"../chunks/48858408.js";import{i as ar,a as rr}from"../chunks/8c84ee26.js";import{u as tr,a as ea}from"../chunks/b1448760.js";var sr=l('<div class="grid gap-4 sm:grid-cols-[1fr_auto] sm:items-end"><div class="space-y-2"><p class="info-kicker">Quick Start</p> <p class="text-xl font-semibold"> </p> <p class="meta-text">Best results come from 5-10 minute daily sessions.</p></div> <!></div>'),or=l("<!> <!>",1),ir=l('<a class="meta-text underline">Go to Phrase Library</a>'),lr=l("<!> <!>",1),nr=l("<!> <!>",1),dr=l('<p class="meta-text">Loading sessions...</p>'),cr=l('<p class="meta-text">No practice sessions yet.</p>'),ur=l('<li class="border border-border/60 bg-background/70 p-4"><div class="flex flex-wrap items-center justify-between gap-3"><div class="space-y-1"><p class="font-semibold"> </p> <p class="meta-text"> </p></div> <a class="info-kicker text-primary underline">Open</a></div></li>'),vr=l('<ul class="space-y-3"></ul>'),pr=l("<!> <!>",1),fr=l('<div class="page-shell page-shell--narrow page-stack"><header class="page-stack"><div><p class="info-kicker">On-the-Go Mode</p> <h1 class="text-5xl sm:text-6xl">Practice Sessions</h1> <p class="meta-text mt-3">Start a short run now, review details later. Primary action first, history second.</p></div> <!></header> <!> <!></div>'),_r=l('<p class="meta-text">Loading session...</p>'),mr=l("<!> <!>",1),gr=l('<a class="meta-text underline">Back to Phrase Library</a>'),$r=l("<!> <!>",1),hr=l('<p class="info-kicker"> </p> <!> <!>',1),br=l('<p class="mt-2 text-destructive"> </p>'),xr=l('<div class="mt-4 space-y-2"><p class="meta-text"> </p> <audio controls class="audio-playback w-full"></audio></div>'),yr=l('<div class="space-y-4 text-left"><div class="border border-dashed border-border/70 bg-background/60 p-4"><p class="meta-text"> </p> <div class="mt-3 flex flex-wrap gap-2"><!> <!></div> <!> <!></div> <div class="flex gap-2"><!> <!></div></div>'),kr=l('<div class="border border-border/50 bg-muted/60 p-3"><p class="info-kicker mb-2">Playback</p> <audio controls class="audio-playback w-full"></audio></div>'),wr=l('<p class="meta-text"> </p>'),Pr=l('<audio controls class="audio-playback w-full"></audio>'),Sr=l('<div class="space-y-3 border border-border/50 bg-muted/40 p-3"><p class="info-kicker"> </p> <p class="text-sm"> </p> <!> <!></div>'),Rr=l('<li class="space-y-3 border border-border/60 bg-background/60 p-4"><div class="flex flex-wrap items-center justify-between gap-2 text-[0.84rem] uppercase tracking-[0.1em]"><span class="meta-text"> </span> <span> </span></div> <!> <!> <!></li>'),Ar=l('<div class="border border-border/60 bg-card/40 p-4 text-left"><p class="info-kicker">Attempt History</p> <ul class="mt-4 space-y-3"></ul></div>'),Mr=l('<div class="space-y-4"><div class="border-2 border-primary bg-primary/6 p-4 text-left"><p class="info-kicker">AI Feedback</p> <p class="mt-1 text-lg font-semibold text-primary"> </p></div> <!> <div class="grid grid-cols-2 gap-2"><!> <!></div></div>'),Lr=l('<div class="border border-border/60 bg-muted/60 p-5 sm:p-6"><p class="info-kicker">English Prompt</p> <p class="mt-2 text-xl font-semibold"> </p></div> <!>',1),Cr=l('<a class="meta-text underline">Back to Sessions</a>'),Tr=l("<!> <!> <!>",1),Ir=l('<div class="page-shell page-shell--compact flex min-h-[80vh] flex-col items-center justify-center"><!></div>');function Xr(ba,xa){Wa(xa,!0);const ya=()=>ga(ar,"$isLoading",da),ka=()=>ga(rr,"$isAuthenticated",da),[da,wa]=Za(),fe=tr(),Y=ea(V.phrases.listAllByUser,{}),Ee=ea(V.practiceSessions.list,{}),se=Se(()=>er.url.searchParams.get("run")??null),ca=ea(V.practiceSessions.get,()=>e(se)?{practiceSessionId:e(se)}:"skip");_a(()=>{!ya()&&!ka()&&ia(Re("/login"))});function ua(o){const n=[...o];for(let p=n.length-1;p>0;p--){const W=Math.floor(Math.random()*(p+1));[n[p],n[W]]=[n[W],n[p]]}return n}let oe=M(ma([])),Me=M(0),Ie=M(!1),je=M(!1),Ne=M(null),Ue=M(!1),_e=M(ma([])),Z=M(null),me=M(null),J=M(""),Oe=M(!1),ge=M(0),ze=M(null),qe=M(!1),He=M(!1),Qe=M(null);_a(()=>{e(se)&&Y.data&&Y.data.length>0&&!e(je)&&(a(oe,ua(Y.data),!0),a(Me,0),a(je,!0)),!e(se)&&e(je)&&(a(je,!1),a(oe,[],!0),a(Me,0),a(Ie,!1),a(Ue,!1),a(J,""),a(ze,null),a(_e,[],!0),a(Z,null),a(me,null),a(ge,0))});const H=Se(()=>e(oe)&&e(oe).length>0?e(oe)[e(Me)]:null),aa=ea(V.attempts.listByPhrase,()=>e(H)?{phraseId:e(H)._id}:"skip"),Pa=Se(()=>e(oe)?.length??0),Sa=Se(()=>e(H)?e(Me)+1:0);function Ra(o){if(!o)return"0:00";const n=Math.floor(o/1e3),p=Math.floor(n/60),W=n%60;return`${p}:${W.toString().padStart(2,"0")}`}const Aa=["audio/webm;codecs=opus","audio/webm","audio/mp4","audio/ogg;codecs=opus"];function Ma(){return typeof MediaRecorder>"u"||typeof MediaRecorder.isTypeSupported!="function"?"":Aa.find(o=>MediaRecorder.isTypeSupported(o))??""}async function La(){a(qe,!0);try{const o=await fe.mutation(V.practiceSessions.start,{}),n=new URL(Re("/practice"),window.location.origin);n.searchParams.set("run",o),await ia(`${n.pathname}${n.search}`)}finally{a(qe,!1)}}async function Ca(){if(e(se)){a(He,!0);try{await fe.mutation(V.practiceSessions.end,{practiceSessionId:e(se)}),await ia(Re("/practice"))}finally{a(He,!1)}}}async function Ta(){if(!(!e(Z)||!e(H)||!e(se))){a(Oe,!0),a(J,""),a(ze,null);try{const o=await fe.mutation(V.attempts.create,{phraseId:e(H)._id,practiceSessionId:e(se),durationMs:e(ge)}),n=await fe.mutation(V.audioUploads.generateUploadUrl,{}),p=await fetch(n,{method:"POST",headers:{"Content-Type":e(Z).type||"audio/webm"},body:e(Z)});if(!p.ok)throw new Error("Failed to upload audio.");const Q=(await p.json()).storageId,z=await fe.mutation(V.audioAssets.create,{storageKey:Q,contentType:e(Z).type||"audio/webm",phraseId:e(H)._id,attemptId:o,durationMs:e(ge)});await fe.mutation(V.attempts.attachAudio,{attemptId:o,audioAssetId:z});const ee=await fe.action(V.aiPipeline.processAttempt,{attemptId:o,phraseId:e(H)._id,englishPrompt:e(H).english,targetPhrase:e(H).translation});a(ze,ee?.feedbackText??"Feedback not available yet.",!0),a(Ie,!0)}catch(o){a(J,o instanceof Error?o.message:"Failed to submit recording.",!0)}finally{a(Oe,!1)}}}function Ia(){a(Ie,!0)}function Ua(){let o=e(Me)+1;o>=e(oe).length&&(a(oe,ua(e(oe)),!0),o=0),a(Me,o,!0),a(Ie,!1),a(Ue,!1),a(J,""),a(ze,null),a(_e,[],!0),a(Z,null),a(me,null),a(ge,0)}async function za(){if(a(J,""),a(_e,[],!0),a(Z,null),a(me,null),a(ge,0),!navigator.mediaDevices?.getUserMedia){a(J,"Audio recording not supported in this browser.");return}try{const o=await navigator.mediaDevices.getUserMedia({audio:!0}),n=Ma(),p=n?new MediaRecorder(o,{mimeType:n}):new MediaRecorder(o);a(Ne,p,!0);const W=Date.now();p.ondataavailable=Q=>{Q.data&&Q.data.size>0&&a(_e,[...e(_e),Q.data],!0)},p.onstop=()=>{const Q=p.mimeType||e(_e)[0]?.type||"audio/webm",z=new Blob(e(_e),{type:Q});a(Z,z,!0),a(me,URL.createObjectURL(z),!0),a(ge,Date.now()-W),o.getTracks().forEach(ee=>ee.stop())},p.start(),a(Ue,!0)}catch(o){a(J,o instanceof Error?o.message:"Failed to start recording.",!0)}}function Da(){!e(Ne)||e(Ne).state!=="recording"||(e(Ne).stop(),a(Ue,!1))}function Fa(){a(_e,[],!0),a(Z,null),a(me,null),a(ge,0),a(J,"")}async function Ba(o){a(Qe,o,!0);try{await fe.mutation(V.humanReviews.flagAttemptReview,{attemptId:o})}catch(n){a(J,n instanceof Error?n.message:"Failed to flag review.",!0)}finally{a(Qe,null)}}var va=ve(),Ea=x(va);{var ja=o=>{var n=fr(),p=i(n),W=t(i(p),2);v(W,()=>Be,(ie,$e)=>{$e(ie,{class:"border border-border/60 bg-background/85 backdrop-blur-sm",children:(xe,ae)=>{var D=ve(),re=x(D);v(re,()=>la,(he,C)=>{C(he,{children:(F,le)=>{var T=sr(),$=i(T),L=t(i($),2),G=i(L);s(L),y(2),s($);var _=t($,2);{let d=Se(()=>e(qe)||!Y.data||Y.data.length===0);pe(_,{onclick:La,get disabled(){return e(d)},size:"lg",class:"w-full sm:w-auto",children:(w,S)=>{y();var u=P();f(()=>g(u,e(qe)?"Starting...":"Start Session")),r(w,u)},$$slots:{default:!0}})}s(T),f(()=>g(G,`${Y.data?.length??0??""} phrases ready to train`)),r(F,T)},$$slots:{default:!0}})}),r(xe,D)},$$slots:{default:!0}})}),s(p);var Q=t(p,2);{var z=ie=>{var $e=ve(),xe=x($e);v(xe,()=>Be,(ae,D)=>{D(ae,{class:"border border-border/60 bg-background/85 backdrop-blur-sm",children:(re,he)=>{var C=lr(),F=x(C);v(F,()=>We,(T,$)=>{$(T,{children:(L,G)=>{var _=or(),d=x(_);v(d,()=>Xe,(S,u)=>{u(S,{children:(B,h)=>{y();var R=P("No phrases yet");r(B,R)},$$slots:{default:!0}})});var w=t(d,2);v(w,()=>Ze,(S,u)=>{u(S,{children:(B,h)=>{y();var R=P("Add phrases first, then come back to start practicing.");r(B,R)},$$slots:{default:!0}})}),r(L,_)},$$slots:{default:!0}})});var le=t(F,2);v(le,()=>na,(T,$)=>{$(T,{children:(L,G)=>{var _=ir();f(d=>Ae(_,"href",d),[()=>Re("/")]),r(L,_)},$$slots:{default:!0}})}),r(re,C)},$$slots:{default:!0}})}),r(ie,$e)};k(Q,ie=>{(!Y.data||Y.data.length===0)&&ie(z)})}var ee=t(Q,2);v(ee,()=>Be,(ie,$e)=>{$e(ie,{class:"border border-border/60 bg-background/85 backdrop-blur-sm",children:(xe,ae)=>{var D=pr(),re=x(D);v(re,()=>We,(C,F)=>{F(C,{children:(le,T)=>{var $=nr(),L=x($);v(L,()=>Xe,(_,d)=>{d(_,{children:(w,S)=>{y();var u=P("Recent Sessions");r(w,u)},$$slots:{default:!0}})});var G=t(L,2);v(G,()=>Ze,(_,d)=>{d(_,{children:(w,S)=>{y();var u=P("Open prior sessions to replay attempts and review corrections.");r(w,u)},$$slots:{default:!0}})}),r(le,$)},$$slots:{default:!0}})});var he=t(re,2);v(he,()=>la,(C,F)=>{F(C,{children:(le,T)=>{var $=ve(),L=x($);{var G=d=>{var w=dr();r(d,w)},_=d=>{var w=ve(),S=x(w);{var u=h=>{var R=cr();r(h,R)},B=h=>{var R=vr();$a(R,21,()=>Ee.data,ha,(I,A)=>{var K=ur(),ye=i(K),ke=i(ye),ne=i(ke),we=i(ne,!0);s(ne);var E=t(ne,2),X=i(E);s(E),s(ke);var U=t(ke,2);s(ye),s(K),f((te,De)=>{g(we,te),g(X,`Attempts: ${e(A).attemptCount??""} â€¢ Phrases: ${e(A).phraseCount??""}`),Ae(U,"href",De)},[()=>new Date(e(A).startedAt).toLocaleString(),()=>Re(`/practice/session/${e(A)._id}`)]),r(I,K)}),s(R),r(h,R)};k(S,h=>{!Ee.data||Ee.data.length===0?h(u):h(B,!1)},!0)}r(d,w)};k(L,d=>{Ee.isLoading?d(G):d(_,!1)})}r(le,$)},$$slots:{default:!0}})}),r(xe,D)},$$slots:{default:!0}})}),s(n),r(o,n)},Na=o=>{var n=Ir(),p=i(n);{var W=z=>{var ee=_r();r(z,ee)},Q=z=>{var ee=ve(),ie=x(ee);{var $e=ae=>{var D=ve(),re=x(D);v(re,()=>Be,(he,C)=>{C(he,{class:"w-full border border-border/60 bg-background/85 backdrop-blur-sm",children:(F,le)=>{var T=$r(),$=x(T);v($,()=>We,(G,_)=>{_(G,{class:"text-center",children:(d,w)=>{var S=mr(),u=x(S);v(u,()=>Xe,(h,R)=>{R(h,{class:"text-2xl",children:(I,A)=>{y();var K=P("No Phrases Yet");r(I,K)},$$slots:{default:!0}})});var B=t(u,2);v(B,()=>Ze,(h,R)=>{R(h,{children:(I,A)=>{y();var K=P("Add phrases in your phrase library first.");r(I,K)},$$slots:{default:!0}})}),r(d,S)},$$slots:{default:!0}})});var L=t($,2);v(L,()=>na,(G,_)=>{_(G,{class:"justify-center",children:(d,w)=>{var S=gr();f(u=>Ae(S,"href",u),[()=>Re("/")]),r(d,S)},$$slots:{default:!0}})}),r(F,T)},$$slots:{default:!0}})}),r(ae,D)},xe=ae=>{var D=ve(),re=x(D);{var he=C=>{var F=ve(),le=x(F);v(le,()=>Be,(T,$)=>{$(T,{class:"w-full border border-border/60 bg-background/85 backdrop-blur-sm",children:(L,G)=>{var _=Tr(),d=x(_);v(d,()=>We,(u,B)=>{B(u,{class:"text-center",children:(h,R)=>{var I=hr(),A=x(I),K=i(A);s(A);var ye=t(A,2);v(ye,()=>Xe,(ne,we)=>{we(ne,{class:"text-3xl sm:text-4xl",children:(E,X)=>{y();var U=P("Practice");r(E,U)},$$slots:{default:!0}})});var ke=t(ye,2);v(ke,()=>Ze,(ne,we)=>{we(ne,{children:(E,X)=>{y();var U=P();f(te=>g(U,`Session started ${te??""}`),[()=>new Date(ca.data?.startedAt??Date.now()).toLocaleTimeString()]),r(E,U)},$$slots:{default:!0}})}),f(()=>g(K,`Phrase ${e(Sa)??""} of ${e(Pa)??""}`)),r(h,I)},$$slots:{default:!0}})});var w=t(d,2);v(w,()=>la,(u,B)=>{B(u,{class:"space-y-6 text-center",children:(h,R)=>{var I=Lr(),A=x(I),K=t(i(A),2),ye=i(K,!0);s(K),s(A);var ke=t(A,2);{var ne=E=>{var X=yr(),U=i(X),te=i(U),De=i(te);s(te);var Le=t(te,2),Ge=i(Le);{var Ke=c=>{pe(c,{onclick:za,size:"lg",children:(m,j)=>{y();var N=P("Start Recording");r(m,N)},$$slots:{default:!0}})},Ve=c=>{pe(c,{onclick:Da,size:"lg",variant:"destructive",children:(m,j)=>{y();var N=P("Stop Recording");r(m,N)},$$slots:{default:!0}})};k(Ge,c=>{e(Ue)?c(Ve,!1):c(Ke)})}var ra=t(Ge,2);{var de=c=>{pe(c,{onclick:Fa,variant:"outline",children:(m,j)=>{y();var N=P("Discard");r(m,N)},$$slots:{default:!0}})};k(ra,c=>{e(me)&&c(de)})}s(Le);var be=t(Le,2);{var ce=c=>{var m=br(),j=i(m,!0);s(m),f(()=>g(j,e(J))),r(c,m)};k(be,c=>{e(J)&&c(ce)})}var ta=t(be,2);{var b=c=>{var m=xr(),j=i(m),N=i(j);s(j);var sa=t(j,2);s(m),f(Ye=>{g(N,`Recorded: ${Ye??""}`),Ae(sa,"src",e(me))},[()=>Ra(e(ge))]),r(c,m)};k(ta,c=>{e(me)&&c(b)})}s(U);var Ce=t(U,2),Te=i(Ce);{let c=Se(()=>!e(Z)||e(Oe));pe(Te,{onclick:Ta,class:"flex-1",size:"lg",get disabled(){return e(c)},children:(m,j)=>{y();var N=P();f(()=>g(N,e(Oe)?"Processing...":"Submit")),r(m,N)},$$slots:{default:!0}})}var Fe=t(Te,2);pe(Fe,{onclick:Ia,variant:"outline",size:"lg",children:(c,m)=>{y();var j=P("Skip");r(c,j)},$$slots:{default:!0}}),s(Ce),s(X),f(()=>g(De,`Speak your ${e(H).targetLanguage??""} response`)),r(E,X)},we=E=>{var X=Mr(),U=i(X),te=t(i(U),2),De=i(te,!0);s(te),s(U);var Le=t(U,2);{var Ge=de=>{var be=Ar(),ce=t(i(be),2);$a(ce,21,()=>aa.data.slice(0,5),ha,(ta,b)=>{var Ce=Rr(),Te=i(Ce),Fe=i(Te),c=i(Fe,!0);s(Fe);var m=t(Fe,2),j=i(m,!0);s(m),s(Te);var N=t(Te,2);{var sa=O=>{var q=kr(),Pe=t(i(q),2);s(q),f(()=>Ae(Pe,"src",e(b).audioUrl)),r(O,q)};k(N,O=>{e(b).audioUrl&&O(sa)})}var Ye=t(N,2);{var Oa=O=>{var q=wr(),Pe=i(q,!0);s(q),f(()=>g(Pe,e(b).feedbackText)),r(O,q)};k(Ye,O=>{e(b).feedbackText&&O(Oa)})}var qa=t(Ye,2);{var Ha=O=>{var q=Sr(),Pe=i(q),Qa=i(Pe);s(Pe);var oa=t(Pe,2),Ga=i(oa);s(oa);var pa=t(oa,2);{var Ka=ue=>{var Je=Pr();f(()=>Ae(Je,"src",e(b).humanReview.initialReview.audioUrl)),r(ue,Je)};k(pa,ue=>{e(b).humanReview.initialReview.audioUrl&&ue(Ka)})}var Va=t(pa,2);{var Ya=ue=>{{let Je=Se(()=>e(Qe)===e(b)._id);pe(ue,{variant:"outline",size:"sm",get disabled(){return e(Je)},onclick:()=>Ba(e(b)._id),children:(Ja,Ur)=>{y();var fa=P();f(()=>g(fa,e(Qe)===e(b)._id?"Flagging...":"Flag Review")),r(Ja,fa)},$$slots:{default:!0}})}};k(Va,ue=>{(e(b).humanReview.status==="completed"||e(b).humanReview.status==="dispute_resolved")&&ue(Ya)})}s(q),f(ue=>{g(Qa,`Human Review ${ue??""}`),g(Ga,`Verifier: ${e(b).humanReview.initialReview.verifierFirstName??""}`)},[()=>e(b).humanReview.status.replace("_"," ")]),r(O,q)};k(qa,O=>{e(b).humanReview?.initialReview&&O(Ha)})}s(Ce),f((O,q)=>{g(c,O),g(j,q)},[()=>new Date(e(b).createdAt).toLocaleString(),()=>e(b).status.replace("_"," ")]),r(ta,Ce)}),s(ce),s(be),r(de,be)};k(Le,de=>{aa.data&&aa.data.length>0&&de(Ge)})}var Ke=t(Le,2),Ve=i(Ke);pe(Ve,{onclick:Ua,size:"lg",children:(de,be)=>{y();var ce=P("Next Phrase");r(de,ce)},$$slots:{default:!0}});var ra=t(Ve,2);pe(ra,{onclick:Ca,variant:"outline",size:"lg",get disabled(){return e(He)},children:(de,be)=>{y();var ce=P();f(()=>g(ce,e(He)?"Ending...":"End Session")),r(de,ce)},$$slots:{default:!0}}),s(Ke),s(X),f(()=>g(De,e(ze)??"Feedback not available yet.")),r(E,X)};k(ke,E=>{e(Ie)?E(we,!1):E(ne)})}f(()=>g(ye,e(H).english)),r(h,I)},$$slots:{default:!0}})});var S=t(w,2);v(S,()=>na,(u,B)=>{B(u,{class:"justify-center",children:(h,R)=>{var I=Cr();f(A=>Ae(I,"href",A),[()=>Re("/practice")]),r(h,I)},$$slots:{default:!0}})}),r(L,_)},$$slots:{default:!0}})}),r(C,F)};k(re,C=>{e(H)&&C(he)},!0)}r(ae,D)};k(ie,ae=>{!Y.data||Y.data.length===0?ae($e):ae(xe,!1)},!0)}r(z,ee)};k(p,z=>{Y.isLoading||ca.isLoading?z(W):z(Q,!1)})}s(n),r(o,n)};k(Ea,o=>{e(se)?o(Na,!1):o(ja)})}r(ba,va),Xa(),wa()}export{Xr as component};
